name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (for example v0.2.0)"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  BINARY_NAME: rlph

jobs:
  resolve-release:
    name: Resolve release tag
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.resolve.outputs.release_tag }}
    steps:
      - name: Determine release tag
        id: resolve
        shell: bash
        env:
          INPUT_TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" && "${GITHUB_REF}" != "refs/heads/main" ]]; then
            echo "::error title=Invalid dispatch ref::Manual releases must run from main (got ${GITHUB_REF})"
            exit 1
          fi

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            release_tag="${INPUT_TAG}"
          else
            release_tag="${GITHUB_REF_NAME}"
          fi

          if [[ ! "${release_tag}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error title=Invalid tag::Release tag must match vX.Y.Z (got ${release_tag})"
            exit 1
          fi

          echo "release_tag=${release_tag}" >> "${GITHUB_OUTPUT}"

  validate-version:
    name: Validate tag and crate version
    needs: resolve-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure tag version matches Cargo.toml
        shell: bash
        env:
          RELEASE_TAG: ${{ needs.resolve-release.outputs.release_tag }}
        run: |
          set -euo pipefail

          release_tag="${RELEASE_TAG}"
          tag_version="${release_tag#v}"
          cargo_version="$(cargo metadata --format-version=1 --no-deps | jq -r '.packages[0].version')"

          if [[ -z "${cargo_version}" ]]; then
            echo "::error title=Missing version::Could not read package.version from Cargo.toml"
            exit 1
          fi

          if [[ "${tag_version}" != "${cargo_version}" ]]; then
            echo "::error title=Version mismatch::Tag ${release_tag} does not match Cargo.toml version ${cargo_version}"
            exit 1
          fi

  build:
    name: Build and package (${{ matrix.target }})
    needs:
      - resolve-release
      - validate-version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            linker: aarch64-linux-gnu-gcc
          - os: macos-14
            target: x86_64-apple-darwin
          - os: macos-14
            target: aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Install Linux cross-compiler
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
      - name: Build
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: ${{ matrix.linker }}
        run: cargo build --release --target ${{ matrix.target }}
      - name: Package archive
        id: package
        shell: bash
        env:
          RELEASE_TAG: ${{ needs.resolve-release.outputs.release_tag }}
          TARGET: ${{ matrix.target }}
        run: |
          set -euo pipefail

          version="${RELEASE_TAG}"
          target="${TARGET}"
          archive_root="${BINARY_NAME}-${version}-${target}"
          archive_name="${archive_root}.tar.gz"

          mkdir -p "dist/${archive_root}"
          cp "target/${target}/release/${BINARY_NAME}" "dist/${archive_root}/"
          cp README.md LICENSE "dist/${archive_root}/"

          tar -C dist -czf "dist/${archive_name}" "${archive_root}"

          echo "archive=dist/${archive_name}" >> "${GITHUB_OUTPUT}"
      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: ${{ steps.package.outputs.archive }}
          if-no-files-found: error

  publish-release:
    name: Publish GitHub release
    needs:
      - resolve-release
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true
      - name: Create GitHub release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve-release.outputs.release_tag }}
          target_commitish: ${{ github.sha }}
          files: release-assets/*.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
